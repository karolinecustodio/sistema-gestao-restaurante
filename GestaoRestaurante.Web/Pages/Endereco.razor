@page "/endereco"
@inject IJSRuntime Js;

<div class="container bg-light">
    <div class="row justify-content-center">
        <div class="card-header">Adicionar Endereço de Entrega</div>
        <div class="form-group">
            <label for="cep">CEP:</label><span class="text-danger">*</span>
            <input @oninput="()=>RetornaDadosCep_Input()" class="form-control" type="text" id="cep" @bind="endereco.Cep" required>
        </div>
        <div class="form-group">
            <label for="rua">Rua:</label><span class="text-danger">*</span>
            <input @bind="endereco.Rua" type="text" class="form-control" id="rua" required>
        </div>

        <div class="form-group">
            <label for="numero">Número:</label><span class="text-danger">*</span>
            <input type="text" class="form-control" id="numero" @bind="endereco.Numero" required>
        </div>

        <div class="form-group">
            <label for="complemento">Complemento:</label>
            <input type="text" class="form-control" id="complemento" @bind="endereco.Complemento">
        </div>

        <div class="form-group">
            <label for="bairro">Bairro:</label><span class="text-danger">*</span>
            <input type="text" class="form-control" id="bairro" @bind="endereco.Bairro" required>
        </div>

        <div class="form-group">
            <label for="cidade">Cidade:</label><span class="text-danger">*</span>
            <input type="text" class="form-control" id="cidade" @bind="endereco.Cidade" required>
        </div>

        <div class="form-group">
            <label for="estado">Estado:</label><span class="text-danger">*</span>
            <input type="text" class="form-control" id="estado" @bind="endereco.Estado" required>
        </div>

        <button class="btn btn-primary" @onclick="SalvarEndereco">Salvar</button>
        @if (MensagemSucesso is not null)
        {
            <div class="alert alert-success" role="alert">
                @MensagemSucesso
            </div>
        }
    </div>
</div>

@code {

    public EnderecoDto endereco { get; set; }

    public string? MensagemSucesso { get; set; }

    private int? userId;

    private List<string> camposPreenchidos = new List<string>();

    [Inject]
    public IGerenciaUsuarioEnderecoLocalStorageService GerenciaUsuarioEnderecoService { get; set; }

    [Inject]
    public IUsuarioEnderecoService UsuarioEnderecoService { get; set; }

    [Inject]
    public IEnderecoService EnderecoService { get; set; }


    protected override async Task OnInitializedAsync()
    {
        endereco = new EnderecoDto();

        userId = await GerenciaUsuarioEnderecoService.GetUserId();

        if (userId.HasValue)
        {
            var usuarioEndereco = await UsuarioEnderecoService.GetUsuarioEnderecoByUsuarioId(userId);
            if (usuarioEndereco != null)
            {
                endereco.Cep = usuarioEndereco.Endereco.Cep;
                endereco.Rua = usuarioEndereco.Endereco.Rua;
                endereco.Numero = usuarioEndereco.Endereco.Numero;
                endereco.Bairro = usuarioEndereco.Endereco.Bairro;
                endereco.Cidade = usuarioEndereco.Endereco.Cidade;
                endereco.Estado = usuarioEndereco.Endereco.Estado;
                endereco.Complemento = usuarioEndereco.Endereco.Complemento;
            }
            else
            {
                endereco.Cep = string.Empty;
                endereco.Rua = string.Empty;
                endereco.Numero = string.Empty;
                endereco.Bairro = string.Empty;
                endereco.Cidade = string.Empty;
                endereco.Estado = string.Empty;
                endereco.Complemento = string.Empty;
            }

        }

    }

    private async Task SalvarEndereco()
    {
        if (userId.HasValue)
        {
            var enderecoSalvar = new EnderecoDto
                {
                    Cep = endereco.Cep,
                    Rua = endereco.Rua,
                    Numero = endereco.Numero,
                    Bairro = endereco.Bairro,
                    Cidade = endereco.Cidade,
                    Estado = endereco.Estado,
                    Complemento = endereco.Complemento
                };

            var enderecoDb = await EnderecoService.PostEndereco(enderecoSalvar);

            var usuarioEnd = new UsuarioEnderecoDto
                {
                    UsuarioId = userId.Value,
                    EnderecoId = enderecoDb.Id
                };

            await UsuarioEnderecoService.PostUsuarioEndereco(usuarioEnd);

            MensagemSucesso = "Endereço salvo!";
        }
    }

    public void AtualizarEndereco(string rua, string bairro, string cidade, string estado)
    {
        Console.WriteLine(rua);
        endereco.Rua = rua;
        endereco.Bairro = bairro;
        endereco.Cidade = cidade;
        endereco.Estado = estado;
    }

    protected async Task RetornaDadosCep_Input()
    {
        await Js.InvokeVoidAsync("BuscaCep");
    }
}
